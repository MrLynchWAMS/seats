<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seating Chart Generator</title>
 <link rel="icon" type="image/svg+xml"
href='data:image/svg+xml;utf8,
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
  <path fill="%23ffffff" stroke="%23000000" stroke-width="1"
        d="M7 3h10v5h2a1 1 0 0 1 1 1v4h-2v8h-2v-8H8v8H6v-8H4V9a1 1 0 0 1 1-1h2V3zM9 8h6V5H9v3z"/>
</svg>'>

    <style>
        /* --- 1. General Styles --- */
        :root {
            --bg-color: #f4f7f6;
            --header-bg: #ffffff;
            --border-color: #daddde;
            --table-bg: #ffffff;
            --seat-bg: #e0eef9;
            --seat-empty-bg: #f0f0f0;
            --seat-locked-bg: #fceceb;
            --seat-locked-border: #e69d9a;
            --text-color: #333;
            --text-light: #555;
            --accent-color: #007bff;
            --accent-hover: #0056b3;
            --danger-color: #dc3545;
            --danger-hover: #b02a37;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --shadow: 0 2px 8px rgba(0,0,0,0.05);
            
            /* Text scale and sizing */
            --text-scale: 1.0;
            --base-chip-w: 85px;
            --chip-w: calc(var(--base-chip-w) * var(--text-scale));
            --chip-gap: calc(0.5rem * var(--text-scale));
            
            /* Table widths */
            --table-w-4: calc(240px * var(--text-scale)); /* 2 columns: 2*110 + gap + padding */
            --table-w-5: calc(240px * var(--text-scale)); /* 2 columns same as 4-seat */
            --table-w-5-land: calc(360px * var(--text-scale)); /* 3 columns for Newton */
            
            /* Gender colors */
            --gender-m-bg: #e3f2fd;
            --gender-m-stripe: #1976d2;
            --gender-f-bg: #fce4ec;
            --gender-f-stripe: #c2185b;
        }
        
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* --- 2. Header & Main Controls --- */
        header {
            background-color: var(--header-bg);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        header h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--accent-color);
        }

        .controls-main {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem; 
        }

        select, button {
            font-family: var(--font-family);
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: #fff;
            cursor: pointer;
        }
        
        button {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: var(--accent-hover);
        }

        button.danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }
        button.danger:hover {
            background-color: var(--danger-hover);
        }
        
        /* --- 3. Main Content Area --- */
        .main-container {
            display: flex;
            flex: 1; /* Take remaining height */
            overflow: hidden;
        }

        /* --- 4. Roster & Settings Panel --- */
        .panel-left {
            width: 300px;
            background-color: #fff;
            border-right: 1px solid var(--border-color);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
            z-index: 10; /* Keep panel on top */
        }
        
        .panel-group {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1.5rem;
        }
        .panel-group:last-child {
            border-bottom: none;
            padding-bottom: 0;
            margin-top: auto; /* Push data ops to bottom */
        }
        
        .panel-group h2 {
            margin: 0 0 1rem 0;
            font-size: 1.2rem;
        }
        
        .roster-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .roster-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        #roster-input {
            width: 100%;
            height: 150px; /* Reduced height */
            box-sizing: border-box; 
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem;
            font-family: "Courier New", Courier, monospace;
            font-size: 0.9rem;
            resize: vertical;
        }
        
        .table-setting-row {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .table-setting-row label {
            font-weight: normal;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .shuffle-options-group div {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        #check-lonely-btn {
            width: 100%;
            margin-top: 0.5rem;
            background-color: #6c757d;
            border-color: #6c757d;
        }
        #check-lonely-btn:hover {
            background-color: #5a6268;
        }
        
        /* Updated data ops grid */
        .data-ops-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }
        #reset-all-btn {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }
        #reset-all-btn:hover {
            background-color: var(--danger-hover);
        }
        
        /* --- 5. Seating Chart Canvas --- */
        .canvas-container {
            flex: 1; /* Take remaining width */
            overflow: auto;
            background-color: var(--bg-color);
            padding: 2rem;
        }
        
        .canvas {
            position: relative;
            min-width: 800px;
            min-height: 600px;
            background-color: #fff;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            border-radius: 8px;
            transform-origin: top left; /* for zoom */
        }
        
        .edit-mode-indicator {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            padding: 0.5rem 0.75rem;
            background-color: var(--accent-color);
            color: white;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        /* --- 6. Tables & Seats (new chip design) --- */
        .table {
            position: absolute;
            background-color: var(--table-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            cursor: grab; /* Default cursor */
            /* width and height dynamically set in JS */
        }
        
        .table.dragging {
            cursor: grabbing; 
            opacity: 0.7;
            z-index: 100;
        }
        
        .table.grabbable {
            cursor: grab;
        }
        .table.grabbable:hover {
            border-color: var(--accent-color);
            box-shadow: 0 4px 12px rgba(0,123,255,0.2);
        }
        
        .table-header {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-color);
            font-size: 0.95rem;
            text-align: center;
        }
        
        .remove-table-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 0.9rem;
            cursor: pointer;
            display: none; /* Hidden unless edit mode */
            line-height: 1;
        }
        .edit-mode .remove-table-btn {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .remove-table-btn:hover {
            background-color: var(--danger-hover);
        }
        
        .seats {
            display: grid;
            gap: var(--chip-gap);
            grid-template-columns: repeat(auto-fit, var(--chip-w));
        }
        
        .seat {
            min-width: var(--chip-w);
            max-width: var(--chip-w);
            min-height: calc(2.0rem * var(--text-scale));
            padding: calc(0.3rem * var(--text-scale)) calc(0.5rem * var(--text-scale));
            background-color: var(--seat-empty-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: calc(0.85rem * var(--text-scale));
            line-height: 1.2;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
        }
        
        .seat.occupied {
            background-color: var(--seat-bg);
            color: var(--text-color);
            font-weight: 500;
        }
        
        /* Gender coloring when enabled */
        .seat.gender-m {
            background-color: var(--gender-m-bg);
        }
        .seat.gender-m::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background-color: var(--gender-m-stripe);
        }
        
        .seat.gender-f {
            background-color: var(--gender-f-bg);
        }
        .seat.gender-f::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background-color: var(--gender-f-stripe);
        }
        
        .seat.locked {
            background-color: var(--seat-locked-bg);
            border-color: var(--seat-locked-border);
        }
        
        .seat:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        /* Lock icon within chip */
        .lock-icon {
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: calc(0.7rem * var(--text-scale));
            color: var(--danger-color);
        }
        
        /* --- 7. Display Options Panel --- */
        .panel-right {
            width: 250px;
            background-color: #fff;
            border-left: 1px solid var(--border-color);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
        }
        
        .display-option-row {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .display-option-row label {
            font-weight: normal;
        }
        .display-option-row select {
            justify-self: end;
        }
        
        #text-size-slider {
            width: 100%;
        }
        #text-size-value {
            text-align: right;
            font-weight: 600;
            color: var(--accent-color);
        }
        
        /* --- 8. Roster Manager Modal --- */
        .roster-manager-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;
        }
        .roster-manager-overlay.modal-visible {
            visibility: visible;
            opacity: 1;
        }
        
        .roster-manager-modal {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 2rem;
        }
        
        .roster-manager-modal h2 {
            margin: 0 0 1.5rem 0;
            font-size: 1.4rem;
            color: var(--accent-color);
        }
        
        .modal-section {
            margin-bottom: 2rem;
        }
        .modal-section h3 {
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
            color: var(--text-color);
        }
        
        #roster-manager-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #roster-manager-list li {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        #roster-manager-list li:last-child {
            border-bottom: none;
        }
        
        .separation-controls {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        #separation-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #separation-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        #separation-list li:last-child {
            border-bottom: none;
        }
        #separation-list li button {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        
        /* --- 9. Shared Link Indicator Banner --- */
        .shared-link-banner {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 0.75rem 1rem;
            text-align: center;
            font-weight: 500;
            display: none; /* Hidden by default */
        }
        .shared-link-banner.visible {
            display: block;
        }
        .shared-link-banner button {
            margin-left: 1rem;
            background-color: #ffc107;
            border-color: #ffc107;
            color: #000;
        }
        .shared-link-banner button:hover {
            background-color: #e0a800;
        }
        
    </style>
</head>
<body>

    <!-- Shared Link Banner -->
    <div id="shared-link-banner" class="shared-link-banner">
        You are viewing a shared seating chart. 
        <button id="save-shared-data-btn">Save to My Browser</button>
        <button id="dismiss-banner-btn" style="background-color: transparent; border: none; color: #856404; text-decoration: underline; cursor: pointer;">Dismiss</button>
    </div>

    <header>
        <h1>ðŸª‘ Seating Chart Generator</h1>
        <div class="controls-main">
            <div class="control-group">
                <label for="class-selector">Class:</label>
                <select id="class-selector"></select>
            </div>
            <button id="edit-layout-btn">Edit Layout</button>
            <button id="add-furniture-btn" style="display:none;">+ Add Table</button>
            <button id="fit-to-screen-btn">Fit to Screen</button>
        </div>
    </header>

    <div class="main-container">
        <!-- Left Panel: Roster & Settings -->
        <div class="panel-left">
            <div class="panel-group roster-group">
                <h2>Roster</h2>
                <label for="roster-input">Student Names (one per line):</label>
                <textarea id="roster-input" placeholder="Alice
Bob
Charlie
Dana"></textarea>
                <div class="roster-buttons">
                    <button id="save-roster-btn">Save Roster</button>
                    <button id="manage-roster-btn">Manage Roster</button>
                </div>
            </div>

            <div class="panel-group shuffle-group">
                <h2>Shuffle & Clear</h2>
                <div class="shuffle-options-group">
                    <div>
                        <input type="checkbox" id="avoid-lonely-check" checked>
                        <label for="avoid-lonely-check">Avoid "lonely" students (same gender)</label>
                    </div>
                    <div>
                        <input type="checkbox" id="respect-locked-check" checked>
                        <label for="respect-locked-check">Respect locked seats</label>
                    </div>
                </div>
                <button id="shuffle-btn">ðŸŽ² Shuffle</button>
                <button id="check-lonely-btn">Check Gender Balance</button>
                <button id="clear-assignments-btn" class="danger">Clear Assignments</button>
            </div>

            <div class="panel-group tables-group">
                <h2>Tables & Layout</h2>
                <div id="table-settings-list">
                    <!-- Table settings rows will be inserted here by JS -->
                </div>
            </div>

            <div class="panel-group data-ops-group">
                <h2>Data</h2>
                <div class="data-ops-grid">
                    <button id="share-link-btn">ðŸ“‹ Share Link</button>
                    <button id="reset-all-btn" class="danger">Reset All</button>
                </div>
            </div>
        </div>

        <!-- Center: Seating Chart Canvas -->
        <div class="canvas-container">
            <div id="canvas" class="canvas">
                <!-- Tables will be rendered here -->
            </div>
        </div>

        <!-- Right Panel: Display Options -->
        <div class="panel-right">
            <div class="panel-group">
                <h2>Display Options</h2>
                
                <div class="display-option-row">
                    <label for="name-format-select">Name Format:</label>
                    <select id="name-format-select">
                        <option value="full">Full Name</option>
                        <option value="first">First Name</option>
                        <option value="last">Last Name</option>
                        <option value="fl">F. Last</option>
                        <option value="lf">Last, F.</option>
                    </select>
                </div>
                
                <div class="display-option-row">
                    <label for="color-by-gender-check">Color by Gender:</label>
                    <input type="checkbox" id="color-by-gender-check">
                </div>
                
                <div class="display-option-row">
                    <label for="text-size-slider">Text Size:</label>
                    <span id="text-size-value">100%</span>
                </div>
                <input type="range" id="text-size-slider" min="70" max="150" value="100">
            </div>
        </div>
    </div>

    <!-- Roster Manager Modal -->
    <div id="roster-manager-overlay" class="roster-manager-overlay">
        <div class="roster-manager-modal">
            <h2>Manage Roster</h2>
            
            <div class="modal-section">
                <h3>Student Genders</h3>
                <ul id="roster-manager-list">
                    <!-- Populated by JS -->
                </ul>
            </div>
            
            <div class="modal-section">
                <h3>Separation Rules</h3>
                <p style="margin-bottom:1rem; color: var(--text-light); font-size: 0.9rem;">
                    Students added here will not be seated at the same table during shuffle.
                </p>
                <div class="separation-controls">
                    <select id="sep-student-1">
                        <option value="">Select student...</option>
                    </select>
                    <select id="sep-student-2">
                        <option value="">Select student...</option>
                    </select>
                    <button id="add-separation-btn">+ Add</button>
                </div>
                <ul id="separation-list">
                    <!-- Populated by JS -->
                </ul>
            </div>
            
            <div class="modal-actions">
                <button id="close-roster-modal-btn">Cancel</button>
                <button id="save-roster-manager-btn">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. STATE MANAGEMENT ---
        
        const DEFAULT_CLASSES = [
            { id: 'class1', name: 'Class 1', roster: [], separations: [], assignments: {} },
            { id: 'class2', name: 'Class 2', roster: [], separations: [], assignments: {} },
            { id: 'class3', name: 'Class 3', roster: [], separations: [], assignments: {} }
        ];
        
        const DEFAULT_TABLES = [
            { id: 't1', name: 'Round 1', type: 'round', x: 100, y: 100 },
            { id: 't2', name: 'Round 2', type: 'round', x: 100, y: 250 },
            { id: 't3', name: 'Round 3', type: 'round', x: 100, y: 400 },
            { id: 't4', name: 'Round 4', type: 'round', x: 400, y: 100 },
            { id: 't5', name: 'Newton', type: 'newton', x: 400, y: 250 }
        ];
        
        let appState = {
            classes: DEFAULT_CLASSES,
            activeClassId: 'class1',
            tables: DEFAULT_TABLES,
            editMode: false,
            nextTableId: 6,
            displayOptions: {
                nameFormat: 'full',
                textScale: 1.0,
                colorByGender: false
            }
        };
        
        let isLoadedFromURL = false; // Track if data came from URL
        
        // --- 2. DOM ELEMENTS ---
        const classSelector = document.getElementById('class-selector');
        const editLayoutBtn = document.getElementById('edit-layout-btn');
        const addFurnitureBtn = document.getElementById('add-furniture-btn');
        const fitToScreenBtn = document.getElementById('fit-to-screen-btn');
        const rosterInput = document.getElementById('roster-input');
        const saveRosterBtn = document.getElementById('save-roster-btn');
        const manageRosterBtn = document.getElementById('manage-roster-btn');
        const shuffleBtn = document.getElementById('shuffle-btn');
        const clearAssignmentsBtn = document.getElementById('clear-assignments-btn');
        const shareLinkBtn = document.getElementById('share-link-btn');
        const resetAllBtn = document.getElementById('reset-all-btn');
        const canvas = document.getElementById('canvas');
        const tableSettingsList = document.getElementById('table-settings-list');
        const checkLonelyBtn = document.getElementById('check-lonely-btn');
        
        // Display options
        const nameFormatSelect = document.getElementById('name-format-select');
        const textSizeSlider = document.getElementById('text-size-slider');
        const textSizeValue = document.getElementById('text-size-value');
        const colorByGenderCheck = document.getElementById('color-by-gender-check');
        
        // Roster Manager Modal
        const rosterManagerOverlay = document.getElementById('roster-manager-overlay');
        const closeRosterModalBtn = document.getElementById('close-roster-modal-btn');
        const saveRosterManagerBtn = document.getElementById('save-roster-manager-btn');
        const rosterManagerList = document.getElementById('roster-manager-list');
        const sepStudent1 = document.getElementById('sep-student-1');
        const sepStudent2 = document.getElementById('sep-student-2');
        const addSeparationBtn = document.getElementById('add-separation-btn');
        const separationList = document.getElementById('separation-list');
        
        // Shared Link Banner
        const sharedLinkBanner = document.getElementById('shared-link-banner');
        const saveSharedDataBtn = document.getElementById('save-shared-data-btn');
        const dismissBannerBtn = document.getElementById('dismiss-banner-btn');
        
        
        // --- 3. STORAGE & LOADING ---
        
        function saveState() {
            // Only save to localStorage if NOT viewing a shared link
            if (!isLoadedFromURL) {
                localStorage.setItem('seatingChartState', JSON.stringify(appState));
            }
        }
        
        function loadState() {
            // Check for URL hash data first
            const hash = window.location.hash;
            if (hash.startsWith('#data=')) {
                try {
                    const encodedData = hash.slice(6);
                    const jsonString = decodeURIComponent(encodedData);
                    const loadedState = JSON.parse(jsonString);
                    
                    // Load the shared state
                    appState = loadedState;
                    isLoadedFromURL = true;
                    
                    // Show banner
                    sharedLinkBanner.classList.add('visible');
                    
                    console.log('Loaded state from URL hash');
                    return;
                } catch (e) {
                    console.error('Failed to parse URL data:', e);
                    alert('Failed to load shared link data. Starting fresh.');
                }
            }
            
            // Otherwise load from localStorage
            const saved = localStorage.getItem('seatingChartState');
            if (saved) {
                try {
                    appState = JSON.parse(saved);
                    console.log('Loaded state from localStorage');
                } catch (e) {
                    console.error('Failed to parse localStorage:', e);
                }
            }
        }
        
        function handleSaveSharedData() {
            // Save the URL data to localStorage
            localStorage.setItem('seatingChartState', JSON.stringify(appState));
            isLoadedFromURL = false;
            sharedLinkBanner.classList.remove('visible');
            
            // Clear the URL hash
            history.replaceState(null, null, ' ');
            
            alert('Seating chart saved to your browser!');
        }
        
        function handleDismissBanner() {
            sharedLinkBanner.classList.remove('visible');
        }
        
        
        // --- 4. RENDERING ---
        
        function render() {
            renderClassSelector();
            renderRosterInput();
            renderCanvas();
            renderTableSettings();
            renderDisplayOptions();
        }
        
        function renderClassSelector() {
            classSelector.innerHTML = '';
            appState.classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.name;
                if (cls.id === appState.activeClassId) {
                    option.selected = true;
                }
                classSelector.appendChild(option);
            });
        }
        
        function renderRosterInput() {
            const activeClass = appState.classes.find(c => c.id === appState.activeClassId);
            if (!activeClass) return;
            
            const rosterText = activeClass.roster.map(s => s.name).join('\n');
            rosterInput.value = rosterText;
        }
        
        function renderCanvas() {
            canvas.innerHTML = '';
            
            if (appState.editMode) {
                const indicator = document.createElement('div');
                indicator.className = 'edit-mode-indicator';
                indicator.textContent = 'âœï¸ Edit Mode';
                canvas.appendChild(indicator);
                canvas.classList.add('edit-mode');
            } else {
                canvas.classList.remove('edit-mode');
            }
            
            const activeClass = appState.classes.find(c => c.id === appState.activeClassId);
            if (!activeClass) return;
            
            appState.tables.forEach(table => {
                const tableEl = createTableElement(table, activeClass);
                canvas.appendChild(tableEl);
            });
        }
        
        function createTableElement(table, activeClass) {
            const tableEl = document.createElement('div');
            tableEl.className = 'table';
            tableEl.dataset.tableId = table.id;
            tableEl.style.left = table.x + 'px';
            tableEl.style.top = table.y + 'px';
            
            if (appState.editMode) {
                tableEl.classList.add('grabbable');
            }
            
            // Determine table dimensions and seat layout
            let seatCount = 0;
            let gridColumns = 2;
            let tableWidth = 'var(--table-w-4)';
            
            if (table.type === 'round') {
                seatCount = 4;
                gridColumns = 2;
                tableWidth = 'var(--table-w-4)';
            } else if (table.type === 'newton') {
                seatCount = 5;
                gridColumns = 3;
                tableWidth = 'var(--table-w-5-land)';
            }
            
            tableEl.style.width = tableWidth;
            
            const header = document.createElement('div');
            header.className = 'table-header';
            header.textContent = table.name;
            tableEl.appendChild(header);
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-table-btn';
            removeBtn.textContent = 'Ã—';
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                handleRemoveTable(table.id);
            });
            tableEl.appendChild(removeBtn);
            
            const seatsContainer = document.createElement('div');
            seatsContainer.className = 'seats';
            seatsContainer.style.gridTemplateColumns = `repeat(${gridColumns}, var(--chip-w))`;
            
            for (let i = 0; i < seatCount; i++) {
                const seatId = `${table.id}-s${i}`;
                const studentName = activeClass.assignments[seatId] || '';
                const seatEl = createSeatElement(seatId, studentName, activeClass);
                seatsContainer.appendChild(seatEl);
            }
            
            tableEl.appendChild(seatsContainer);
            
            if (appState.editMode) {
                makeTableDraggable(tableEl, table);
            }
            
            return tableEl;
        }
        
        function createSeatElement(seatId, studentName, activeClass) {
            const seatEl = document.createElement('div');
            seatEl.className = 'seat';
            seatEl.dataset.seatId = seatId;
            
            const student = activeClass.roster.find(s => s.name === studentName);
            
            if (studentName) {
                seatEl.classList.add('occupied');
                seatEl.textContent = formatStudentName(studentName);
                
                if (appState.displayOptions.colorByGender && student) {
                    if (student.gender === 'M') {
                        seatEl.classList.add('gender-m');
                    } else if (student.gender === 'F') {
                        seatEl.classList.add('gender-f');
                    }
                }
                
                if (student && student.locked && student.locked === seatId) {
                    seatEl.classList.add('locked');
                    const lockIcon = document.createElement('span');
                    lockIcon.className = 'lock-icon';
                    lockIcon.textContent = 'ðŸ”’';
                    seatEl.appendChild(lockIcon);
                }
            } else {
                seatEl.textContent = 'â€”';
            }
            
            seatEl.addEventListener('click', () => handleSeatClick(seatId));
            
            return seatEl;
        }
        
        function formatStudentName(fullName) {
            const format = appState.displayOptions.nameFormat;
            const parts = fullName.trim().split(/\s+/);
            
            if (parts.length === 1) return fullName;
            
            const first = parts[0];
            const last = parts[parts.length - 1];
            
            switch (format) {
                case 'first': return first;
                case 'last': return last;
                case 'fl': return `${first.charAt(0)}. ${last}`;
                case 'lf': return `${last}, ${first.charAt(0)}.`;
                case 'full':
                default: return fullName;
            }
        }
        
        function renderTableSettings() {
            tableSettingsList.innerHTML = '';
            
            appState.tables.forEach(table => {
                const row = document.createElement('div');
                row.className = 'table-setting-row';
                
                const label = document.createElement('label');
                label.textContent = table.name;
                label.title = table.name;
                
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = table.name;
                nameInput.style.fontSize = '0.9rem';
                nameInput.style.padding = '0.3rem 0.5rem';
                nameInput.addEventListener('change', (e) => {
                    table.name = e.target.value || `Table ${table.id}`;
                    saveState();
                    render();
                });
                
                const typeSelect = document.createElement('select');
                typeSelect.style.fontSize = '0.9rem';
                typeSelect.style.padding = '0.3rem 0.5rem';
                
                const roundOpt = document.createElement('option');
                roundOpt.value = 'round';
                roundOpt.textContent = 'Round (4)';
                typeSelect.appendChild(roundOpt);
                
                const newtonOpt = document.createElement('option');
                newtonOpt.value = 'newton';
                newtonOpt.textContent = 'Newton (5)';
                typeSelect.appendChild(newtonOpt);
                
                typeSelect.value = table.type;
                typeSelect.addEventListener('change', (e) => {
                    table.type = e.target.value;
                    
                    // Clear assignments for this table
                    const activeClass = appState.classes.find(c => c.id === appState.activeClassId);
                    if (activeClass) {
                        for (let key in activeClass.assignments) {
                            if (key.startsWith(table.id + '-')) {
                                delete activeClass.assignments[key];
                            }
                        }
                    }
                    
                    saveState();
                    render();
                });
                
                row.appendChild(label);
                row.appendChild(nameInput);
                row.appendChild(typeSelect);
                tableSettingsList.appendChild(row);
            });
        }
        
        function renderDisplayOptions() {
            nameFormatSelect.value = appState.displayOptions.nameFormat;
            textSizeSlider.value = appState.displayOptions.textScale * 100;
            textSizeValue.textContent = Math.round(appState.displayOptions.textScale * 100) + '%';
            colorByGenderCheck.checked = appState.displayOptions.colorByGender;
            
            document.documentElement.style.setProperty('--text-scale', appState.displayOptions.textScale);
        }
        
        
        // --- 5. EVENT HANDLERS ---
        
        function handleClassChange() {
            appState.activeClassId = classSelector.value;
            saveState();
            render();
        }
        
        function handleToggleEditMode() {
            appState.editMode = !appState.editMode;
            editLayoutBtn.textContent = appState.editMode ? 'Done Editing' : 'Edit Layout';
            addFurnitureBtn.style.display = appState.editMode ? 'inline-block' : 'none';
            render();
        }
        
        function handleAddFurniture() {
            const newTable = {
                id: `t${appState.nextTableId++}`,
                name: `Table ${appState.nextTableId - 1}`,
                type: 'round',
                x: 100,
                y: 100
            };
            appState.tables.push(newTable);
            saveState();
            render();
        }
        
        function handleRemoveTable(tableId) {
            if (!confirm('Remove this table and all its seat assignments?')) return;
            
            appState.tables = appState.tables.filter(t => t.id !== tableId);
            
            appState.classes.forEach(cls => {
                for (let key in cls.assignments) {
                    if (key.startsWith(tableId + '-')) {
                        delete cls.assignments[key];
                    }
                }
            });
            
            saveState();
            render();
        }
        
        function handleFitToScreen() {
            const container = document.querySelector('.canvas-container');
            const canvasEl = document.getElementById('canvas');
            
            let maxX = 0, maxY = 0;
            appState.tables.forEach(table => {
                const tableWidth = table.type === 'newton' ? 360 : 240;
                const tableHeight = 150;
                maxX = Math.max(maxX, table.x + tableWidth);
                maxY = Math.max(maxY, table.y + tableHeight);
            });
            
            const contentWidth = maxX + 100;
            const contentHeight = maxY + 100;
            
            const containerWidth = container.clientWidth - 80;
            const containerHeight = container.clientHeight - 80;
            
            const scaleX = containerWidth / contentWidth;
            const scaleY = containerHeight / contentHeight;
            const scale = Math.min(scaleX, scaleY, 1.0);
            
            canvasEl.style.transform = `scale(${scale})`;
            canvasEl.style.minWidth = contentWidth + 'px';
            canvasEl.style.minHeight = contentHeight + 'px';
        }
        
        function handleSaveRoster() {
            const activeClass = appState.classes.find(c => c.id === appState.activeClassId);
            if (!activeClass) return;
            
            const lines = rosterInput.value.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            
            const newRoster = [];
            const existingMap = {};
            activeClass.roster.forEach(student => {
                existingMap[student.name] = student;
            });
            
            lines.forEach(name => {
                if (existingMap[name]) {
                    newRoster.push(existingMap[name]);
                } else {
                    newRoster.push({ name: name, gender: 'U', locked: null });
                }
            });
            
            const removedNames = activeClass.roster.map(s => s.name).filter(name => !lines.includes(name));
            removedNames.forEach(name => {
                for (let seatId in activeClass.assignments) {
                    if (activeClass.assignments[seatId] === name) {
                        delete activeClass.assignments[seatId];
                    }
                }
            });
            
            activeClass.roster = newRoster;
            
            saveState();
            render();
            alert('Roster saved!');
        }
        
        function handleManageRoster() {
            renderRosterManagerModal();
            rosterManagerOverlay.classList.add('modal-visible');
        }
        
        function handleShuffle() {
            const activeClass = appState.classes.find(c => c.id === appState.activeClassId);
            if (!activeClass) return;
            
            const respectLocked = document.getElementById('respect-locked-check').checked;
            const avoidLonely = document.getElementById('avoid-lonely-check').checked;
            
            const lockedSeats = {};
            if (respectLocked) {
                for (let seatId in activeClass.assignments) {
                    const studentName = activeClass.assignments[seatId];
                    const student = activeClass.roster.find(s => s.name === studentName);
                    if (student && student.locked === seatId) {
                        lockedSeats[seatId] = studentName;
                    }
                }
            }
            
            const availableSeats = [];
            appState.tables.forEach(table => {
                const seatCount = table.type === 'newton' ? 5 : 4;
                for (let i = 0; i < seatCount; i++) {
                    const seatId = `${table.id}-s${i}`;
                    if (!lockedSeats[seatId]) {
                        availableSeats.push(seatId);
                    }
                }
            });
            
            const studentsToAssign = activeClass.roster.filter(student => {
                if (respectLocked && student.locked) {
                    return false;
                }
                return true;
            });
            
            if (studentsToAssign.length > availableSeats.length) {
                alert(`Not enough seats! You have ${studentsToAssign.length} students but only ${availableSeats.length} available seats.`);
                return;
            }
            
            activeClass.assignments = { ...lockedSeats };
            
            const separations = activeClass.separations || [];
            const genderMap = {};
            activeClass.roster.forEach(student => {
                genderMap[student.name] = student.gender || 'U';
            });
            
            let bestAssignment = null;
            let bestScore = Infinity;
            const maxAttempts = 100;
            
            for (let attempt = 0; attempt < maxAttempts; attempt++) {
                const shuffled = [...studentsToAssign].sort(() => Math.random() - 0.5);
                const testAssignments = { ...lockedSeats };
                
                shuffled.forEach((student, i) => {
                    testAssignments[availableSeats[i]] = student.name;
                });
                
                let score = 0;
                
                // Penalty for separation violations
                for (const pair of separations) {
                    const name1 = pair[0];
                    const name2 = pair[1];
                    const table1 = Object.keys(testAssignments).find(k => testAssignments[k] === name1)?.split('-s')[0];
                    const table2 = Object.keys(testAssignments).find(k => testAssignments[k] === name2)?.split('-s')[0];
                    if (table1 && table1 === table2) {
                        score += 100;
                    }
                }
                
                // Penalty for lonely students
                if (avoidLonely) {
                    const tableGroups = {};
                    for (const seatId in testAssignments) {
                        const studentName = testAssignments[seatId];
                        const tableId = seatId.split('-s')[0];
                        if (!tableGroups[tableId]) tableGroups[tableId] = [];
                        tableGroups[tableId].push(studentName);
                    }
                    
                    for (const tableId in tableGroups) {
                        const studentsOnTable = tableGroups[tableId];
                        if (studentsOnTable.length < 2) continue;
                        
                        const counts = { M: 0, F: 0, U: 0 };
                        studentsOnTable.forEach(name => {
                            counts[genderMap[name]]++;
                        });
                        
                        if ((counts.M === 1 && counts.F > 0) || (counts.F === 1 && counts.M > 0)) {
                            score += 10;
                        }
                    }
                }
                
                if (score < bestScore) {
                    bestScore = score;
                    bestAssignment = testAssignments;
                }
                
                if (score === 0) break;
            }
            
            if (bestAssignment) {
                activeClass.assignments = bestAssignment;
            }
            
            saveState();
            render();
            
            if (avoidLonely) {
                checkLonelyStudents(true);
            }
            checkSeparations();
        }
        
        function handleClearAssignments() {
            if (!confirm('Clear all seat assignments for this class?')) return;
            
            const activeClass = appState.classes.find(c => c.id === appState.activeClassId);
            if (!activeClass) return;
            
            activeClass.assignments = {};
            
            activeClass.roster.forEach(student => {
                student.locked = null;
            });
            
            saveState();
            render();
        }
        
        function handleShareLink() {
            const stateString = JSON.stringify(appState);
            const encodedData = encodeURIComponent(stateString);
            const url = `${window.location.origin}${window.location.pathname}#data=${encodedData}`;
            
            navigator.clipboard.writeText(url).then(() => {
                alert('Shareable link copied to clipboard! Anyone with this link can view your seating chart.');
            }).catch(() => {
                prompt('Copy this link to share:', url);
            });
        }
        
        function handleResetAll() {
            if (!confirm('Reset ALL data (all classes, tables, settings)? This cannot be undone.')) return;
            
            localStorage.removeItem('seatingChartState');
            appState = {
                classes: JSON.parse(JSON.stringify(DEFAULT_CLASSES)),
                activeClassId: 'class1',
                tables: JSON.parse(JSON.stringify(DEFAULT_TABLES)),
                editMode: false,
                nextTableId: 6,
                displayOptions: {
                    nameFormat: 'full',
                    textScale: 1.0,
                    colorByGender: false
                }
            };
            isLoadedFromURL = false;
            render();
            alert('All data has been reset.');
        }
        
        function handleSeatClick(seatId) {
            const activeClass = appState.classes.find(c => c.id === appState.activeClassId);
            if (!activeClass) return;
            
            const currentStudent = activeClass.assignments[seatId];
            
            if (currentStudent) {
                const student = activeClass.roster.find(s => s.name === currentStudent);
                if (student) {
                    if (student.locked === seatId) {
                        student.locked = null;
                    } else {
                        student.locked = seatId;
                    }
                    saveState();
                    render();
                }
                return;
            }
            
            const assignedNames = Object.values(activeClass.assignments);
            const unassignedStudents = activeClass.roster.filter(s => !assignedNames.includes(s.name));
            
            if (unassignedStudents.length === 0) {
                alert('All students are already assigned. Clear a seat first or add more students.');
                return;
            }
            
            const studentName = prompt(
                `Assign a student to this seat:\n\nAvailable students:\n${unassignedStudents.map(s => s.name).join(', ')}\n\nEnter name:`
            );
            
            if (!studentName) return;
            
            const trimmedName = studentName.trim();
            const student = activeClass.roster.find(s => s.name === trimmedName);
            
            if (!student) {
                alert(`Student "${trimmedName}" not found in roster.`);
                return;
            }
            
            if (assignedNames.includes(trimmedName)) {
                alert(`${trimmedName} is already assigned to another seat.`);
                return;
            }
            
            activeClass.assignments[seatId] = trimmedName;
            saveState();
            render();
        }
        
        function handleNameFormatChange() {
            appState.displayOptions.nameFormat = nameFormatSelect.value;
            saveState();
            render();
        }
        
        function handleTextSizeChange() {
            const scale = textSizeSlider.value / 100;
            appState.displayOptions.textScale = scale;
            saveState();
            renderDisplayOptions();
            render();
        }
        
        function handleColorByGenderChange() {
            appState.displayOptions.colorByGender = colorByGenderCheck.checked;
            saveState();
            render();
        }
        
        
        // --- 6. DRAGGABLE TABLES ---
        
        function makeTableDraggable(tableEl, tableData) {
            let isDragging = false;
            let offsetX = 0;
            let offsetY = 0;
            
            tableEl.addEventListener('mousedown', (e) => {
                if (e.target.closest('.remove-table-btn')) return;
                
                isDragging = true;
                tableEl.classList.add('dragging');
                
                const rect = tableEl.getBoundingClientRect();
                const canvasRect = canvas.getBoundingClientRect();
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;
                
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const canvasRect = canvas.getBoundingClientRect();
                let newX = e.clientX - canvasRect.left - offsetX;
                let newY = e.clientY - canvasRect.top - offsetY;
                
                newX = Math.max(0, newX);
                newY = Math.max(0, newY);
                
                tableEl.style.left = newX + 'px';
                tableEl.style.top = newY + 'px';
            });
            
            document.addEventListener('mouseup', () => {
                if (!isDragging) return;
                
                isDragging = false;
                tableEl.classList.remove('dragging');
                
                tableData.x = parseInt(tableEl.style.left);
                tableData.y = parseInt(tableEl.style.top);
                
                saveState();
            });
        }
        
        
        // --- 7. ROSTER MANAGER MODAL ---
        
        function renderRosterManagerModal() {
            const activeClass = appState.classes.find(c => c.id === appState.activeClassId);
            if (!activeClass) return;
            
            const separations = activeClass.separations || [];
            
            // 1. Populate Gender Selection List
            rosterManagerList.innerHTML = '';
            activeClass.roster.forEach(student => {
                const li = document.createElement('li');
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = student.name;
                
                const genderSelect = document.createElement('select');
                genderSelect.dataset.name = student.name;
                
                const optU = document.createElement('option');
                optU.value = 'U';
                optU.textContent = 'Unknown';
                genderSelect.appendChild(optU);
                
                const optM = document.createElement('option');
                optM.value = 'M';
                optM.textContent = 'Male';
                genderSelect.appendChild(optM);
                
                const optF = document.createElement('option');
                optF.value = 'F';
                optF.textContent = 'Female';
                genderSelect.appendChild(optF);
                
                genderSelect.value = student.gender || 'U';
                
                li.appendChild(nameSpan);
                li.appendChild(genderSelect);
                rosterManagerList.appendChild(li);
            });
            
            // 2. Populate Separation Dropdowns
            sepStudent1.innerHTML = '<option value="">Select student...</option>';
            sepStudent2.innerHTML = '<option value="">Select student...</option>';
            activeClass.roster.forEach(student => {
                const opt1 = document.createElement('option');
                opt1.value = student.name;
                opt1.textContent = student.name;
                sepStudent1.appendChild(opt1);
                
                const opt2 = document.createElement('option');
                opt2.value = student.name;
                opt2.textContent = student.name;
                sepStudent2.appendChild(opt2);
            });
            
            // 3. Populate Current Separation List
            separationList.innerHTML = '';
            if (separations.length === 0) {
                separationList.innerHTML = '<li>No separations defined.</li>';
            }
            separations.forEach(pair => {
                const li = document.createElement('li');
                li.textContent = `${pair[0]} & ${pair[1]}`;
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Remove';
                removeBtn.className = 'danger';
                removeBtn.dataset.name1 = pair[0];
                removeBtn.dataset.name2 = pair[1];
                li.appendChild(removeBtn);
                separationList.appendChild(li);
            });
        }
        
        function handleSaveRosterManager() {
            const activeClass = appState.classes.find(c => c.id === appState.activeClassId);
            
            // 1. Save Genders
            const selects = rosterManagerList.querySelectorAll('select');
            selects.forEach(select => {
                const name = select.dataset.name;
                const gender = select.value;
                const student = activeClass.roster.find(s => s.name === name);
                if (student) {
                    student.gender = gender;
                }
            });
            
            saveState();
            closeRosterModal();
            alert('Roster changes saved!');
        }
        
        function handleAddSeparation() {
            const name1 = sepStudent1.value;
            const name2 = sepStudent2.value;
            
            if (!name1 || !name2 || name1 === name2) {
                alert("Please select two different students.");
                return;
            }
            
            const activeClass = appState.classes.find(c => c.id === appState.activeClassId);
            const separations = activeClass.separations;
            
            const exists = separations.some(pair => 
                (pair[0] === name1 && pair[1] === name2) || (pair[0] === name2 && pair[1] === name1)
            );
            
            if (exists) {
                alert("This separation rule already exists.");
                return;
            }
            
            separations.push([name1, name2]);
            renderRosterManagerModal();
        }
        
        function handleRemoveSeparation(e) {
            if (!e.target.matches('button.danger')) return;
            
            const name1 = e.target.dataset.name1;
            const name2 = e.target.dataset.name2;
            const activeClass = appState.classes.find(c => c.id === appState.activeClassId);
            
            activeClass.separations = activeClass.separations.filter(pair => 
                !((pair[0] === name1 && pair[1] === name2) || (pair[0] === name2 && pair[1] === name1))
            );
            
            renderRosterManagerModal();
        }
        
        function closeRosterModal() {
            rosterManagerOverlay.classList.remove('modal-visible');
        }
        
        function checkLonelyStudents(isAfterShuffle = false) {
            if (!document.getElementById('avoid-lonely-check').checked && !isAfterShuffle) {
                alert("Please check the \"Avoid 'lonely' students\" box to use this feature.");
                return;
            }
            
            const activeClass = appState.classes.find(c => c.id === appState.activeClassId);
            const assignments = activeClass.assignments;
            
            const genderMap = {};
            activeClass.roster.forEach(student => {
                genderMap[student.name] = student.gender || 'U';
            });
            
            const tableGroups = {};
            for (const seatId in assignments) {
                const studentName = assignments[seatId];
                if (!studentName) continue;
                const tableId = seatId.split('-s')[0];
                if (!tableGroups[tableId]) tableGroups[tableId] = [];
                tableGroups[tableId].push(studentName);
            }
            
            const lonelyStudents = [];
            for (const tableId in tableGroups) {
                const studentsOnTable = tableGroups[tableId];
                if (studentsOnTable.length < 2) continue;
                
                const counts = { M: 0, F: 0, U: 0 };
                studentsOnTable.forEach(name => {
                    counts[genderMap[name]]++;
                });
                
                if (counts.M === 1 && counts.F > 0) {
                    const lonelyName = studentsOnTable.find(name => genderMap[name] === 'M');
                    lonelyStudents.push({ name: lonelyName, tableId: tableId });
                } else if (counts.F === 1 && counts.M > 0) {
                    const lonelyName = studentsOnTable.find(name => genderMap[name] === 'F');
                    lonelyStudents.push({ name: lonelyName, tableId: tableId });
                }
            }
            
            if (lonelyStudents.length > 0) {
                const tableNames = appState.tables.reduce((acc, table) => {
                    acc[table.id] = table.name;
                    return acc;
                }, {});
                
                const message = lonelyStudents
                    .map(s => `${s.name} (at ${tableNames[s.tableId]})`)
                    .join('\n');
                
                alert(`Warning: The following students are the only one of their gender at their table:\n\n${message}\n\nYou may want to move them manually.`);
            } else if (!isAfterShuffle) {
                alert("Gender check complete: No 'lonely' students found!");
            }
        }
        
        function checkSeparations() {
            const activeClass = appState.classes.find(c => c.id === appState.activeClassId);
            const separations = activeClass.separations || [];
            if (separations.length === 0) return;
            
            const assignments = activeClass.assignments;
            
            const studentLocations = {};
            for (const seatId in assignments) {
                const studentName = assignments[seatId];
                if (!studentName) continue;
                const tableId = seatId.split('-s')[0];
                studentLocations[studentName] = tableId;
            }
            
            const violations = [];
            for (const pair of separations) {
                const name1 = pair[0];
                const name2 = pair[1];
                
                if (studentLocations[name1] && studentLocations[name1] === studentLocations[name2]) {
                    violations.push({ name1, name2, tableId: studentLocations[name1] });
                }
            }
            
            if (violations.length > 0) {
                const tableNames = appState.tables.reduce((acc, table) => {
                    acc[table.id] = table.name;
                    return acc;
                }, {});
                
                const message = violations
                    .map(v => `${v.name1} & ${v.name2} (at ${tableNames[v.tableId]})`)
                    .join('\n');
                
                alert(`Warning: The following incompatible students are at the same table:\n\n${message}\n\nYou may want to move them manually.`);
            }
        }


        // --- 8. INITIALIZATION ---
        
        classSelector.addEventListener('change', handleClassChange);
        editLayoutBtn.addEventListener('click', handleToggleEditMode);
        addFurnitureBtn.addEventListener('click', handleAddFurniture);
        fitToScreenBtn.addEventListener('click', handleFitToScreen);
        saveRosterBtn.addEventListener('click', handleSaveRoster);
        manageRosterBtn.addEventListener('click', handleManageRoster);
        shuffleBtn.addEventListener('click', handleShuffle);
        clearAssignmentsBtn.addEventListener('click', handleClearAssignments);
        shareLinkBtn.addEventListener('click', handleShareLink);
        resetAllBtn.addEventListener('click', handleResetAll);
        checkLonelyBtn.addEventListener('click', () => checkLonelyStudents(false));
        
        // Display Options Listeners
        nameFormatSelect.addEventListener('change', handleNameFormatChange);
        textSizeSlider.addEventListener('input', handleTextSizeChange);
        colorByGenderCheck.addEventListener('change', handleColorByGenderChange);
        
        // Roster Modal Listeners
        closeRosterModalBtn.addEventListener('click', closeRosterModal);
        saveRosterManagerBtn.addEventListener('click', handleSaveRosterManager);
        addSeparationBtn.addEventListener('click', handleAddSeparation);
        separationList.addEventListener('click', handleRemoveSeparation);
        rosterManagerOverlay.addEventListener('click', (e) => {
            if (e.target === rosterManagerOverlay) closeRosterModal();
        });
        
        // Shared Link Banner Listeners
        saveSharedDataBtn.addEventListener('click', handleSaveSharedData);
        dismissBannerBtn.addEventListener('click', handleDismissBanner);
        
        // First load and render
        loadState();
        render();

    });
    </script>
</body>
</html>
